<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Laser Engraving Control - GENGRAV</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Laser Engraving Control</h1>
      <div class="connection-status">
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="connectionStatus">Not Connected</span>
      </div>
    </div>

    <div class="content">
      <!-- LEFT PANEL: Controls & Options -->
      <div class="left-panel">
        <!-- Connection Section -->
        <div class="panel-section">
          <h2>üîå Connection</h2>
          <div class="form-group">
            <label for="portSelect">Arduino Port</label>
            <select id="portSelect">
              <option value="">Select Port...</option>
            </select>
          </div>
          <div class="button-group">
            <button id="refreshPortsBtn" class="btn-secondary">Refresh</button>
            <button id="connectBtn" class="btn-primary">Connect</button>
            <button id="disconnectBtn" class="btn-danger" disabled>Disconnect</button>
          </div>
        </div>

        <!-- Machine Control Section -->
        <div class="panel-section">
          <h2>‚öôÔ∏è Machine Control</h2>
          <div class="button-grid">
            <button id="setHomeBtn" class="btn-control" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1V10" />
              </svg>
              Set Home
            </button>
            <button id="goHomeBtn" class="btn-control" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path d="M12 2v4M12 18v4M2 12h4M18 12h4" />
              </svg>
              Go Home
            </button>
            <button id="resetBtn" class="btn-control" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                <path d="M12 8v4l2 2" />
              </svg>
              Reset
            </button>
            <button id="testEngraveBtn" class="btn-success" disabled>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" />
              </svg>
              Test 10mm
            </button>
          </div>
        </div>

        <!-- Laser Control Section -->
        <div class="panel-section">
          <h2>üí° Laser Control</h2>
          <div class="form-group">
            <label>Power: <strong id="powerValue">100</strong>% (S<span id="sValue">1000</span>)</label>
            <input type="range" id="laserPower" min="0" max="100" value="100" class="slider">
          </div>
          <div class="button-group">
            <button id="laserOnBtn" class="btn-warning" disabled>‚ö° Laser ON</button>
            <button id="laserOffBtn" class="btn-secondary" disabled>Laser OFF</button>
          </div>
        </div>

        <!-- QR Preview & Settings -->
        <div class="panel-section">
          <h2>üìê Engraving Settings</h2>
          <div id="qrPreview" class="qr-preview">
            <p class="placeholder-text">Select a QR code to preview</p>
          </div>
          <div class="form-group">
            <label for="qrSize">QR Size: <strong id="qrSizeValue">30</strong>mm</label>
            <input type="range" id="qrSize" min="10" max="80" value="30" step="5" class="slider">
          </div>
          <div class="button-group">
            <button id="generateGcodeBtn" class="btn-primary" disabled>Generate G-Code</button>
            <button id="previewGcodeBtn" class="btn-secondary" disabled>Preview</button>
          </div>
          <div id="gcodeStatus" class="gcode-status"></div>
        </div>

        <!-- Engraving Controls -->
        <div class="panel-section">
          <h2>‚ñ∂Ô∏è Engraving</h2>
          <div class="button-group">
            <button id="startEngravingBtn" class="btn-success" disabled style="flex: 1;">
              ‚ñ∂ Start Engraving
            </button>
            <button id="stopEngravingBtn" class="btn-danger" disabled>
              ‚ñ† Stop
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL: Console, Jobs & QR Files -->
      <div class="right-panel">
        <!-- Status Dashboard -->
        <div class="panel-section">
          <h2>üìä Status Dashboard</h2>
          <div class="status-display">
            <div class="status-item">
              <span class="status-label">Machine:</span>
              <span class="status-value" id="machineStatus">Idle</span>
            </div>
            <div class="status-item">
              <span class="status-label">Laser:</span>
              <span class="status-value" id="laserState">OFF</span>
            </div>
            <div class="status-item">
              <span class="status-label">Current Job:</span>
              <span class="status-value" id="currentJob">None</span>
            </div>
            <div class="status-item">
              <span class="status-label">Jobs Done:</span>
              <span class="status-value" id="jobsDone">0</span>
            </div>
          </div>
        </div>

        <!-- QR Files from Directory -->
        <div class="panel-section">
          <h2>üìÅ QR Codes (from Database)</h2>
          <div class="form-group">
            <label for="batchFilter">Filter by Batch</label>
            <select id="batchFilter">
              <option value="">All Items</option>
            </select>
          </div>
          <div id="batchStats" class="batch-stats" style="display: none;">
            <span><strong>Total:</strong> <span id="batchTotal">0</span></span>
            <span><strong>Engraved:</strong> <span id="batchEngraved">0</span></span>
            <span><strong>Pending:</strong> <span id="batchPending">0</span></span>
          </div>
          <div id="itemsList" class="items-list">
            <div class="empty-state-small">
              <p>Loading QR codes...</p>
            </div>
          </div>
          <div class="button-group">
            <button id="refreshBatchesBtn" class="btn-secondary btn-sm">Refresh Batches</button>
            <button id="refreshItemsBtn" class="btn-secondary btn-sm">Refresh Items</button>
          </div>
        </div>

        <!-- Engraving Queue -->
        <div class="panel-section">
          <h2>üìã Engraving Queue</h2>
          <div id="queueList" class="queue-list">
            <div class="empty-state-small">
              <p>No jobs in queue</p>
            </div>
          </div>
          <button id="refreshQueueBtn" class="btn-secondary btn-sm">Refresh Queue</button>
        </div>

        <!-- Console Output -->
        <div class="panel-section">
          <h2>üíª Console Output</h2>
          <div id="console" class="console"></div>
          <button id="clearConsoleBtn" class="btn-secondary btn-sm">Clear Console</button>
        </div>

        <!-- G-Code Preview (hidden by default) -->
        <div class="panel-section" id="gcodePreviewSection" style="display: none;">
          <h2>üìú G-Code Preview</h2>
          <div id="gcodePreviewContent" class="gcode-preview"></div>
          <div class="button-group">
            <button id="executeGcodeBtn" class="btn-success">Execute G-Code</button>
            <button id="closeGcodePreviewBtn" class="btn-secondary">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let isConnected = false;
    let laserPower = 100;
    let selectedItem = null;
    let currentGcode = null;
    let jobsDoneCount = 0;

    // Log to console
    function log(message, type = 'info') {
      const consoleEl = document.getElementById('console');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      consoleEl.appendChild(logEntry);
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // Update connection UI
    function updateConnectionUI(connected) {
      isConnected = connected;
      const indicator = document.getElementById('statusIndicator');
      const status = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');

      if (connected) {
        indicator.className = 'status-indicator connected';
        status.textContent = 'Connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;

        document.querySelectorAll('.btn-control, #laserOnBtn, #laserOffBtn, #testEngraveBtn, #startEngravingBtn').forEach(btn => {
          btn.disabled = false;
        });

        if (currentGcode) {
          document.getElementById('executeGcodeBtn').disabled = false;
        }
      } else {
        indicator.className = 'status-indicator disconnected';
        status.textContent = 'Not Connected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;

        document.querySelectorAll('.btn-control, #laserOnBtn, #laserOffBtn, #testEngraveBtn, #startEngravingBtn').forEach(btn => {
          btn.disabled = true;
        });
      }
    }

    // Refresh batches list
    async function refreshBatches() {
      log('Loading batches...', 'info');
      const result = await ipcRenderer.invoke('get-all-batches');
      const batchFilter = document.getElementById('batchFilter');
      const currentValue = batchFilter.value;

      batchFilter.innerHTML = '<option value="">All Items</option>';

      if (result.success && result.batches.length > 0) {
        log(`Loaded ${result.batches.length} batches`, 'success');
        result.batches.forEach((batch) => {
          const option = document.createElement('option');
          option.value = batch.batch_ref_id;
          option.textContent = `${batch.batch_ref_id} (${parseInt(batch.qr_count).toLocaleString()})`;
          batchFilter.appendChild(option);
        });
        if (currentValue) batchFilter.value = currentValue;
      }
    }

    // Handle batch filter change
    async function onBatchFilterChange() {
      const batchRefId = document.getElementById('batchFilter').value;
      const batchStats = document.getElementById('batchStats');

      if (batchRefId) {
        const statsResult = await ipcRenderer.invoke('get-batch-stats', batchRefId);
        if (statsResult.success && statsResult.stats) {
          const stats = statsResult.stats;
          document.getElementById('batchTotal').textContent = parseInt(stats.total_count).toLocaleString();
          document.getElementById('batchEngraved').textContent = parseInt(stats.engraved_count).toLocaleString();
          document.getElementById('batchPending').textContent = parseInt(stats.manufactured_count).toLocaleString();
          batchStats.style.display = 'flex';
        }
      } else {
        batchStats.style.display = 'none';
      }
      await refreshItems();
    }

    // Refresh items from database
    async function refreshItems() {
      const batchRefId = document.getElementById('batchFilter').value;
      log(`Loading items${batchRefId ? ' (filtered)' : ''}...`, 'info');

      let result = batchRefId
        ? await ipcRenderer.invoke('get-items-by-batch', batchRefId)
        : await ipcRenderer.invoke('get-all-items');

      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = '';

      if (result.success && result.items.length > 0) {
        log(`Loaded ${result.items.length} items`, 'success');

        result.items.forEach((item) => {
          const itemEl = document.createElement('div');
          itemEl.className = 'item-card' + (selectedItem?.uid === item.uid ? ' selected' : '');

          itemEl.innerHTML = `
            <div class="item-header">
              <strong>${item.uid.substring(0, 25)}...</strong>
              <span class="item-status ${item.current_status}">${item.current_status}</span>
            </div>
            <div class="item-details">
              <small>${item.component_type} | ${item.lot_number}</small>
            </div>
            ${item.qr_image_url ? '<span class="qr-badge">QR ‚úì</span>' : '<span class="qr-badge missing">No QR</span>'}
          `;
          itemEl.addEventListener('click', () => selectItem(item));
          itemsList.appendChild(itemEl);
        });
      } else {
        itemsList.innerHTML = '<div class="empty-state-small"><p>No items found</p></div>';
      }
    }

    // Select item and show QR preview
    function selectItem(item) {
      selectedItem = item;
      log(`Selected: ${item.uid.substring(0, 30)}...`, 'info');

      document.querySelectorAll('.item-card').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');

      const qrPreview = document.getElementById('qrPreview');
      if (item.qr_image_url) {
        qrPreview.innerHTML = `<img src="${item.qr_image_url}" alt="QR Code"/>`;
        document.getElementById('generateGcodeBtn').disabled = false;
        document.getElementById('previewGcodeBtn').disabled = false;
      } else {
        qrPreview.innerHTML = '<p class="placeholder-text">No QR image</p>';
        document.getElementById('generateGcodeBtn').disabled = true;
        document.getElementById('previewGcodeBtn').disabled = true;
      }

      document.getElementById('currentJob').textContent = item.uid.substring(0, 20) + '...';
    }

    // Generate G-code
    async function generateGcode() {
      if (!selectedItem || !selectedItem.qr_image_url) {
        log('No item selected', 'error');
        return;
      }

      const qrSize = parseInt(document.getElementById('qrSize').value) || 30;
      const power = parseInt(document.getElementById('laserPower').value) || 100;
      log(`Generating G-code (${qrSize}mm, ${power}%)...`, 'info');

      const result = await ipcRenderer.invoke('generate-gcode-from-base64', {
        base64Data: selectedItem.qr_image_url,
        size: qrSize,
        itemUid: selectedItem.uid,
        laserPower: power
      });

      if (result.success) {
        currentGcode = result.gcode;
        log(`G-code ready: ${result.lineCount} commands`, 'success');
        document.getElementById('gcodeStatus').innerHTML = `<span class="success">‚úì ${result.lineCount} commands</span>`;
        if (isConnected) document.getElementById('executeGcodeBtn').disabled = false;
      } else {
        log(`G-code failed: ${result.error}`, 'error');
        document.getElementById('gcodeStatus').innerHTML = `<span class="error">‚úó ${result.error}</span>`;
      }
    }

    // Preview G-code
    async function previewGcode() {
      if (!selectedItem) return;

      const qrSize = parseInt(document.getElementById('qrSize').value) || 30;
      const power = parseInt(document.getElementById('laserPower').value) || 100;

      const result = await ipcRenderer.invoke('generate-gcode-from-base64', {
        base64Data: selectedItem.qr_image_url,
        size: qrSize,
        itemUid: selectedItem.uid,
        laserPower: power
      });

      if (result.success) {
        currentGcode = result.gcode;
        document.getElementById('gcodePreviewSection').style.display = 'block';
        document.getElementById('gcodePreviewContent').innerHTML =
          `<pre>${result.gcode.substring(0, 3000)}${result.gcode.length > 3000 ? '\n... (truncated)' : ''}</pre>`;
        if (isConnected) document.getElementById('executeGcodeBtn').disabled = false;
        log(`Preview ready: ${result.lineCount} lines`, 'success');
      }
    }

    // Execute G-code
    async function executeGcode() {
      if (!currentGcode || !isConnected) return;

      log('Executing G-code...', 'success');
      document.getElementById('machineStatus').textContent = 'Engraving...';

      const result = await ipcRenderer.invoke('execute-gcode', currentGcode);

      if (result.success) {
        log('Engraving complete!', 'success');
        document.getElementById('machineStatus').textContent = 'Complete';
        jobsDoneCount++;
        document.getElementById('jobsDone').textContent = jobsDoneCount;

        if (selectedItem) {
          await ipcRenderer.invoke('update-item-status', selectedItem.uid, 'engraved');
          refreshItems();
        }
      } else {
        log(`Error: ${result.error}`, 'error');
        document.getElementById('machineStatus').textContent = 'Error';
      }
    }

    // Refresh ports
    async function refreshPorts() {
      log('Scanning ports...');
      const ports = await ipcRenderer.invoke('list-ports');
      const portSelect = document.getElementById('portSelect');
      portSelect.innerHTML = '<option value="">Select Port...</option>';

      ports.forEach(port => {
        const option = document.createElement('option');
        option.value = port.path;
        option.textContent = `${port.path} ${port.manufacturer ? '(' + port.manufacturer + ')' : ''}`;
        portSelect.appendChild(option);
      });

      log(`Found ${ports.length} port(s)`, 'success');
      if (ports.length === 1) {
        portSelect.value = ports[0].path;
        log(`Auto-selected: ${ports[0].path}`, 'info');
      }
    }

    // Connect
    async function connect() {
      const portPath = document.getElementById('portSelect').value;
      if (!portPath) {
        log('Select a port first', 'error');
        return;
      }

      log(`Connecting to ${portPath}...`);
      const result = await ipcRenderer.invoke('connect', portPath);

      if (result.success) {
        log('Connected!', 'success');
        updateConnectionUI(true);
      } else {
        log(`Failed: ${result.error}`, 'error');
      }
    }

    // Disconnect
    async function disconnect() {
      log('Disconnecting...');
      await ipcRenderer.invoke('disconnect');
      log('Disconnected', 'info');
      updateConnectionUI(false);
    }

    // Home controls
    async function setHome() {
      log('Setting home position...', 'info');
      const result = await ipcRenderer.invoke('home-machine');
      if (result.success) log('Home set', 'success');
      else log(`Error: ${result.error}`, 'error');
    }

    async function goToHome() {
      log('Moving to home...', 'info');
      const result = await ipcRenderer.invoke('go-to-home');
      if (result.success) log('At home', 'success');
      else log(`Error: ${result.error}`, 'error');
    }

    async function reset() {
      log('Resetting...');
      const result = await ipcRenderer.invoke('reset');
      if (result.success) log('Reset done', 'success');
      else log(`Error: ${result.error}`, 'error');
    }

    // Laser controls
    async function laserOn() {
      log(`Laser ON at ${laserPower}%...`, 'warning');
      const result = await ipcRenderer.invoke('laser-on', laserPower);
      if (result.success) {
        document.getElementById('laserState').textContent = `ON (${laserPower}%)`;
        log('Laser ON', 'warning');
      } else log(`Error: ${result.error}`, 'error');
    }

    async function laserOff() {
      log('Laser OFF...');
      const result = await ipcRenderer.invoke('laser-off');
      if (result.success) {
        document.getElementById('laserState').textContent = 'OFF';
        log('Laser OFF', 'success');
      } else log(`Error: ${result.error}`, 'error');
    }

    // Test engrave
    async function testEngrave() {
      log('Test engraving (10mm square)...', 'success');
      const result = await ipcRenderer.invoke('test-engrave');
      if (result.success) log('Test complete', 'success');
      else log(`Error: ${result.error}`, 'error');
    }

    // Refresh queue
    async function refreshQueue() {
      const result = await ipcRenderer.invoke('refresh-queue');
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';

      if (result.success && result.jobs.length > 0) {
        result.jobs.forEach((job) => {
          const jobItem = document.createElement('div');
          jobItem.className = 'queue-item';
          jobItem.innerHTML = `
            <strong>Job #${job.id}</strong><br/>
            <small>${job.item_uid.substring(0, 25)}...</small>
          `;
          jobItem.addEventListener('click', () => engraveFromQueue(job));
          queueList.appendChild(jobItem);
        });
      } else {
        queueList.innerHTML = '<div class="empty-state-small"><p>No jobs in queue</p></div>';
      }
    }

    // Start engraving (from selected item)
    async function startEngraving() {
      if (!selectedItem) {
        log('Select an item first', 'error');
        return;
      }

      if (!currentGcode) {
        await generateGcode();
      }

      if (currentGcode) {
        await executeGcode();
      }
    }

    // Close G-code preview
    function closeGcodePreview() {
      document.getElementById('gcodePreviewSection').style.display = 'none';
    }

    // Event listeners
    document.getElementById('refreshPortsBtn').addEventListener('click', refreshPorts);
    document.getElementById('connectBtn').addEventListener('click', connect);
    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
    document.getElementById('setHomeBtn').addEventListener('click', setHome);
    document.getElementById('goHomeBtn').addEventListener('click', goToHome);
    document.getElementById('resetBtn').addEventListener('click', reset);
    document.getElementById('laserOnBtn').addEventListener('click', laserOn);
    document.getElementById('laserOffBtn').addEventListener('click', laserOff);
    document.getElementById('testEngraveBtn').addEventListener('click', testEngrave);
    document.getElementById('generateGcodeBtn').addEventListener('click', generateGcode);
    document.getElementById('previewGcodeBtn').addEventListener('click', previewGcode);
    document.getElementById('executeGcodeBtn').addEventListener('click', executeGcode);
    document.getElementById('closeGcodePreviewBtn').addEventListener('click', closeGcodePreview);
    document.getElementById('startEngravingBtn').addEventListener('click', startEngraving);
    document.getElementById('refreshBatchesBtn').addEventListener('click', refreshBatches);
    document.getElementById('refreshItemsBtn').addEventListener('click', refreshItems);
    document.getElementById('refreshQueueBtn').addEventListener('click', refreshQueue);
    document.getElementById('clearConsoleBtn').addEventListener('click', () => {
      document.getElementById('console').innerHTML = '';
      log('Console cleared', 'info');
    });
    document.getElementById('batchFilter').addEventListener('change', onBatchFilterChange);

    // Laser power slider
    document.getElementById('laserPower').addEventListener('input', (e) => {
      laserPower = parseInt(e.target.value);
      document.getElementById('powerValue').textContent = laserPower;
      document.getElementById('sValue').textContent = Math.round(laserPower * 10);
    });

    // QR size slider
    document.getElementById('qrSize').addEventListener('input', (e) => {
      document.getElementById('qrSizeValue').textContent = e.target.value;
    });

    // Initialize
    async function init() {
      log('GENGRAV Engraving App started', 'success');
      await refreshPorts();
      await refreshBatches();
      await refreshItems();
      await refreshQueue();
    }

    init();
  </script>
</body>

</html>