<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GENGRAV - QR Code Generation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      overflow-x: hidden;
    }

    .app-container {
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1rem;
      opacity: 0.9;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 450px 1fr;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
    }

    .card-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .card-body {
      padding: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #444;
      font-size: 0.9rem;
    }

    .form-group label .required {
      color: #e74c3c;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group .hint {
      display: block;
      font-size: 0.8rem;
      color: #999;
      margin-top: 5px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex: 1;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .qr-results {
      max-height: calc(100vh - 160px);
      overflow-y: auto;
    }

    .qr-results::-webkit-scrollbar {
      width: 8px;
    }

    .qr-results::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #666;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    .qr-item {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }

    .qr-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .qr-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .qr-item-header h3 {
      font-size: 1.1rem;
      color: #333;
      font-weight: 600;
      word-break: break-all;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      background: #4CAF50;
      color: white;
    }

    .qr-item-body {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
    }

    .qr-details {
      display: grid;
      gap: 8px;
    }

    .qr-detail-row {
      display: flex;
      font-size: 0.9rem;
    }

    .qr-detail-label {
      font-weight: 600;
      color: #666;
      min-width: 120px;
    }

    .qr-detail-value {
      color: #333;
    }

    .qr-image-container {
      text-align: center;
    }

    .qr-image-container img {
      width: 180px;
      height: 180px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      background: white;
      display: block;
    }

    .qr-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.85rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-download {
      background: #4CAF50;
      color: white;
    }

    .btn-download:hover {
      background: #45a049;
    }

    .btn-print {
      background: #2196F3;
      color: white;
    }

    .btn-print:hover {
      background: #0b7dda;
    }

    .qr-item-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      font-size: 0.8rem;
      color: #999;
    }

    .batch-info {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .batch-info.visible {
      display: block;
    }

    .batch-info h4 {
      color: #2e7d32;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .batch-info p {
      color: #555;
      font-size: 0.85rem;
      margin: 4px 0;
    }

    .progress-container {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .progress-container.visible {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .progress-text {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <h1>üî≤ GENGRAV</h1>
      <p>QR Code Generation System</p>
    </div>

    <div class="main-content">
      <div class="card">
        <div class="card-header">
          <h2>Component Details</h2>
        </div>
        <div class="card-body">
          <form id="qrForm">
            <div class="form-group">
              <label>Generation Mode <span class="required">*</span></label>
              <select id="generationMode" required onchange="toggleGenerationMode()">
                <option value="single">Single Generation (1-1000 QRs)</option>
                <option value="batch">Batch Generation (50K-10L QRs)</option>
              </select>
            </div>

            <div class="form-group" id="batchSizeGroup" style="display: none;">
              <label>Batch Size <span class="required">*</span></label>
              <select id="batchSize">
                <option value="50000">50,000 QR Codes</option>
                <option value="100000">1,00,000 QR Codes</option>
                <option value="500000">5,00,000 QR Codes</option>
                <option value="1000000">10,00,000 QR Codes</option>
              </select>
              <span class="hint">Batch Reference ID will be auto-generated</span>
            </div>

            <div class="form-group">
              <label>Component Type <span class="required">*</span></label>
              <select id="componentType" required>
                <option value="">Select Component Type</option>
                <option value="ERC">ERC - Elastic Rail Clip</option>
                <option value="LINER">LINER - Rail Liner</option>
                <option value="PAD">PAD - Rail Pad</option>
                <option value="SLEEPER">SLEEPER - Railway Sleeper</option>
              </select>
            </div>

            <div class="form-group">
              <label>Lot Number <span class="required">*</span></label>
              <select id="lotNumber" required>
                <option value="">Select Lot Number</option>
                <option value="LOT1234">LOT1234</option>
                <option value="LOT5678">LOT5678</option>
                <option value="LOT9012">LOT9012</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Vendor ID <span class="required">*</span></label>
                <select id="vendorId" required>
                  <option value="">Select Vendor</option>
                  <option value="101">Vendor 101</option>
                  <option value="102">Vendor 102</option>
                  <option value="103">Vendor 103</option>
                </select>
              </div>

              <div class="form-group">
                <label>Warranty Years <span class="required">*</span></label>
                <input type="number" id="warrantyYears" value="5" min="1" max="20" required>
                <span class="hint">1 - 20 years</span>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group" id="quantityGroup">
                <label>Quantity <span class="required">*</span></label>
                <input type="number" id="quantity" value="1" min="1" max="1000" required>
                <span class="hint">1 - 1000 items</span>
              </div>

              <div class="form-group">
                <label>Manufacturing Date <span class="required">*</span></label>
                <input type="date" id="manufactureDate" required>
                <span class="hint">Cannot be in future</span>
              </div>
            </div>

            <div class="batch-info" id="batchInfo">
              <h4>üì¶ Batch Generation Active</h4>
              <p><strong>Batch Reference ID:</strong> <span id="batchRefId">-</span></p>
              <p><strong>Total QR Codes:</strong> <span id="batchTotal">-</span></p>
              <p>This batch will be saved with a unique reference ID for easy engraving selection.</p>
            </div>

            <div class="progress-container" id="progressContainer">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
              </div>
              <div class="progress-text" id="progressText">Generating QR codes...</div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary" id="generateBtn">
                <span>üî≤</span>
                <span id="btnText">Generate 1 QR Code</span>
              </button>
              <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Generated QR Codes (<span id="qrCount">0</span>)</h2>
        </div>
        <div class="card-body">
          <div id="qrResults" class="qr-results">
            <div class="empty-state">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              <h3>No QR Codes Generated</h3>
              <p>Fill in the form and click Generate to create QR codes</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('manufactureDate').setAttribute('max', today);
    document.getElementById('manufactureDate').value = today;

    let generatedQRs = [];

    function toggleGenerationMode() {
      const mode = document.getElementById('generationMode').value;
      const batchSizeGroup = document.getElementById('batchSizeGroup');
      const quantityGroup = document.getElementById('quantityGroup');
      const batchInfo = document.getElementById('batchInfo');
      const btnText = document.getElementById('btnText');

      if (mode === 'batch') {
        batchSizeGroup.style.display = 'block';
        quantityGroup.style.display = 'none';
        document.getElementById('quantity').required = false;
        document.getElementById('batchSize').required = true;
        
        const batchSize = parseInt(document.getElementById('batchSize').value);
        const batchRefId = generateBatchRefId();
        document.getElementById('batchRefId').textContent = batchRefId;
        document.getElementById('batchTotal').textContent = batchSize.toLocaleString();
        batchInfo.classList.add('visible');
        
        btnText.textContent = `Generate Batch (${(batchSize/1000).toFixed(0)}K QR Codes)`;
      } else {
        batchSizeGroup.style.display = 'none';
        quantityGroup.style.display = 'block';
        document.getElementById('quantity').required = true;
        document.getElementById('batchSize').required = false;
        batchInfo.classList.remove('visible');
        
        const qty = document.getElementById('quantity').value || 1;
        btnText.textContent = `Generate ${qty} QR Code${qty > 1 ? 's' : ''}`;
      }
    }

    function generateBatchRefId() {
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return `BATCH-${timestamp}-${random}`;
    }

    document.getElementById('batchSize').addEventListener('change', () => {
      if (document.getElementById('generationMode').value === 'batch') {
        const batchSize = parseInt(document.getElementById('batchSize').value);
        const batchRefId = generateBatchRefId();
        document.getElementById('batchRefId').textContent = batchRefId;
        document.getElementById('batchTotal').textContent = batchSize.toLocaleString();
        document.getElementById('btnText').textContent = `Generate Batch (${(batchSize/1000).toFixed(0)}K QR Codes)`;
      }
    });

    document.getElementById('quantity').addEventListener('input', (e) => {
      const qty = e.target.value || 1;
      if (document.getElementById('generationMode').value === 'single') {
        document.getElementById('btnText').textContent = `Generate ${qty} QR Code${qty > 1 ? 's' : ''}`;
      }
    });

    function resetForm() {
      document.getElementById('qrForm').reset();
      document.getElementById('manufactureDate').value = today;
      document.getElementById('btnText').textContent = 'Generate 1 QR Code';
    }

    async function displayQR(data) {
      generatedQRs.push(data);
      document.getElementById('qrCount').textContent = generatedQRs.length;

      const resultsContainer = document.getElementById('qrResults');
      
      if (generatedQRs.length === 1) {
        resultsContainer.innerHTML = '';
      }

      let qrImage = '';
      if (data.qr_image_url) {
        if (data.qr_image_url.startsWith('data:image/png;base64,')) {
          qrImage = data.qr_image_url;
        } else {
          const result = await window.electronAPI.getQRImage(data.qr_image_url);
          if (result.success) qrImage = result.dataUrl;
        }
      }

      const qrItem = document.createElement('div');
      qrItem.className = 'qr-item';
      qrItem.innerHTML = `
        <div class="qr-item-header">
          <h3>${data.uid}</h3>
          <span class="status-badge">${data.current_status || 'Manufactured'}</span>
        </div>
        <div class="qr-item-body">
          <div class="qr-details">
            <div class="qr-detail-row">
              <span class="qr-detail-label">Component:</span>
              <span class="qr-detail-value">${data.component_type}</span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Lot Number:</span>
              <span class="qr-detail-value">${data.lot_number}</span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Vendor ID:</span>
              <span class="qr-detail-value">${data.vendor_id}</span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Warranty:</span>
              <span class="qr-detail-value">${data.warranty_years} years</span>
            </div>
          </div>
          ${qrImage ? `
          <div class="qr-image-container">
            <img src="${qrImage}" alt="QR Code">
            <div class="qr-actions">
              <button class="btn-small btn-download" onclick="downloadQR('${data.uid}', '${qrImage}')">
                üì• Download
              </button>
              <button class="btn-small btn-print" onclick="printQR('${data.uid}', '${qrImage}')">
                üñ®Ô∏è Print
              </button>
            </div>
          </div>
          ` : '<div style="padding: 20px; text-align: center; color: #999;">QR Code not available</div>'}
        </div>
        <div class="qr-item-footer">
          Created: ${new Date(data.created_at || Date.now()).toLocaleString()}
        </div>
      `;

      resultsContainer.insertBefore(qrItem, resultsContainer.firstChild);
    }

    function downloadQR(uid, dataUrl) {
      const link = document.createElement('a');
      link.download = `${uid}.png`;
      link.href = dataUrl;
      link.click();
    }

    function printQR(uid, dataUrl) {
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
          <head>
            <title>Print QR - ${uid}</title>
            <style>
              body { text-align: center; padding: 40px; font-family: Arial; }
              img { width: 400px; height: 400px; border: 2px solid #333; padding: 15px; background: white; }
              h2 { margin-bottom: 20px; word-break: break-all; }
            </style>
          </head>
          <body>
            <h2>${uid}</h2>
            <img src="${dataUrl}">
            <script>window.onload = () => { window.print(); window.onafterprint = () => window.close(); }<\/script>
          </body>
        </html>
      `);
      win.document.close();
    }

    // Listen for progress updates
    window.electronAPI.onCreationProgress((data) => {
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressContainer.classList.add('visible');
      progressFill.style.width = `${data.percentage}%`;
      progressFill.textContent = `${data.percentage}%`;
      progressText.textContent = `Generated ${data.current.toLocaleString()} of ${data.total.toLocaleString()} QR codes...`;
    });

    document.getElementById('qrForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('btnText');
      const originalText = btnText.textContent;
      const mode = document.getElementById('generationMode').value;

      btn.disabled = true;
      btnText.textContent = 'Generating...';

      try {
        const quantity = mode === 'batch' 
          ? parseInt(document.getElementById('batchSize').value)
          : parseInt(document.getElementById('quantity').value);

        const batchRefId = mode === 'batch' ? document.getElementById('batchRefId').textContent : null;

        const formData = {
          uid: `${document.getElementById('componentType').value}-${document.getElementById('lotNumber').value}`,
          component_type: document.getElementById('componentType').value,
          lot_number: document.getElementById('lotNumber').value,
          vendor_id: parseInt(document.getElementById('vendorId').value),
          warranty_years: parseInt(document.getElementById('warrantyYears').value),
          manufacture_date: document.getElementById('manufactureDate').value,
          quantity: quantity,
          current_status: 'manufactured',
          batch_mode: mode === 'batch',
          batch_ref_id: batchRefId
        };

        const result = await window.electronAPI.createItem(formData);
        
        if (result.success) {
          // Only display first few items in UI for batch mode
          const itemsToDisplay = mode === 'batch' ? result.items.slice(0, 5) : result.items;
          for (const item of itemsToDisplay) {
            await displayQR(item);
          }
          
          if (mode === 'batch') {
            alert(`‚úÖ Successfully generated batch: ${result.count.toLocaleString()} QR codes!\n\nBatch Reference ID: ${batchRefId}\n\nFirst 5 items shown in preview. All QR codes saved to database.`);
          } else {
            alert(`‚úÖ Successfully generated ${result.count} QR code${result.count > 1 ? 's' : ''}!`);
          }
          
          // Reset progress bar
          document.getElementById('progressContainer').classList.remove('visible');
          document.getElementById('progressFill').style.width = '0%';
        } else {
          alert(`‚ùå Error: ${result.error || 'Failed to generate QR codes'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btnText.textContent = originalText;
      }
    });
  </script>
</body>
</html>
